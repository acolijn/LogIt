
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width:300px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keywordModalLabel">Select Keywords</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="keywordList">
                    <!-- Keywords will be populated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateKeywords()">Update Keywords</button>
            </div>
        </div>
    </div>
</div>

<script>
    function openKeywordModal(entryId) {
        Promise.all([
            fetch('/get-keywords').then(response => {
                if (!response.ok) throw Error('Error fetching keywords: ' + response.statusText);
                return response.json();
            }),
            fetch('/get-entry-keywords/' + entryId).then(response => {
                if (!response.ok) throw Error('Error fetching entry keywords: ' + response.statusText);
                return response.json();
            })
        ]).then(([allowedKeywords, currentKeywords]) => {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = ''; // Clear any previous keywords.
            allowedKeywords.keywords.forEach(keyword => {
                const listItem = document.createElement('li');
                listItem.textContent = keyword;
                listItem.className = 'keyword-item'; // Add a class to style it.
                if (currentKeywords.keywords.includes(keyword)) {
                    listItem.classList.add('selected'); // Add selected class if the keyword is in the entry's current keywords.
                }
                listItem.onclick = function () {
                    this.classList.toggle('selected'); // Toggle selected class on click.
                };
                keywordList.appendChild(listItem);
            });

            const modalElement = document.getElementById('keywordModal');
            const modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show(); // This uses Bootstrap's method to show the modal.

            modalElement.dataset.entryId = entryId; // Store entryId in the modal to use it in updateKeywords function.
        }).catch(error => {
            console.error(error); // Log any error that occurred during the fetch.
        });
    }


    function updateKeywords() {
        const modal = document.getElementById('keywordModal');
        const entryId = modal.dataset.entryId;
        const selectedKeywords = Array.from(modal.querySelectorAll('.keyword-item.selected'))
            .map(li => li.textContent); // Only send those that have the 'selected' class.

        if (selectedKeywords.length === 0) {
            // If no keywords are selected, consider "None" as a selected keyword.
            selectedKeywords.push('None');
        }

        fetch('/update-entry-keywords/' + entryId, {
            method: 'POST',
            body: JSON.stringify({ keywords: selectedKeywords }),
            headers: { 'Content-Type': 'application/json' }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to update keywords');
            }
        });
        const modalElement = document.getElementById('keywordModal');
        const modalInstance = new bootstrap.Modal(modalElement);
        modalInstance.hide(); // This uses Bootstrap's method to hide the modal.
    }

    function closeModal() {
        document.getElementById('keywordModal').style.display = 'none';
    }

</script>